<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ú¯Ø§Ù…â€ŒØ´Ù…Ø§Ø± Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ú©Ù‡Ú©Ø´Ø§Ù†ÛŒ</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- FontAwesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Vazir Font (Persian) -->
    <link href="https://cdn.jsdelivr.net/gh/rastikerdar/vazirmatn@v33.003/Vazirmatn-font-face.css" rel="stylesheet" type="text/css" />

    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            background-color: #0f172a;
            color: white;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; 
        }
        ::-webkit-scrollbar-thumb {
            background: #3b82f6; 
            border-radius: 3px;
        }

        /* Glassmorphism */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Neon Glow Animation */
        @keyframes pulse-neon {
            0% { box-shadow: 0 0 10px #3b82f6, 0 0 20px #3b82f6; }
            50% { box-shadow: 0 0 20px #60a5fa, 0 0 40px #60a5fa; }
            100% { box-shadow: 0 0 10px #3b82f6, 0 0 20px #3b82f6; }
        }

        .circle-progress {
            transition: stroke-dashoffset 0.5s ease-in-out;
        }

        .coin-anim {
            animation: spin-coin 1s ease-in-out;
        }

        @keyframes spin-coin {
            0% { transform: scale(1) rotateY(0); }
            50% { transform: scale(1.5) rotateY(180deg); }
            100% { transform: scale(1) rotateY(360deg); }
        }

        .step-bounce {
            animation: bounce 0.3s;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center pb-20">

    <!-- Header -->
    <header class="w-full p-4 flex justify-between items-center glass sticky top-0 z-50">
        <div class="flex items-center gap-2 text-yellow-400 font-bold text-xl">
            <i id="coin-icon" class="fas fa-coins text-2xl"></i>
            <span id="coin-display">0</span>
        </div>
        <h1 class="text-lg font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-400 to-purple-500">
            Ú¯Ø§Ù…â€ŒØ´Ù…Ø§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯
        </h1>
        <button onclick="openSettings()" class="text-gray-400 hover:text-white">
            <i class="fas fa-cog text-xl"></i>
        </button>
    </header>

    <!-- Permission Warning (Initially Hidden) -->
    <div id="permission-btn" class="hidden w-11/12 mt-4 bg-blue-600 text-white p-4 rounded-xl shadow-lg text-center cursor-pointer hover:bg-blue-700 transition">
        <i class="fas fa-lock mb-2 text-2xl"></i>
        <p>Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ú¯Ø§Ù…â€ŒØ´Ù…Ø§Ø±ÛŒ Ø¯Ø± Ø¢ÛŒÙÙˆÙ†/Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ø¬Ø¯ÛŒØ¯ØŒ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø³Ù†Ø³ÙˆØ± ØµØ§Ø¯Ø± Ø´ÙˆØ¯.</p>
    </div>

    <!-- Main Counter Circle -->
    <div class="relative mt-8 mb-6 group">
        <!-- SVG Circle Progress -->
        <svg class="w-72 h-72 transform -rotate-90">
            <circle cx="144" cy="144" r="130" stroke="#1e293b" stroke-width="20" fill="transparent" />
            <circle id="progress-ring" cx="144" cy="144" r="130" stroke="url(#gradient)" stroke-width="20" fill="transparent" 
                    stroke-dasharray="816" stroke-dashoffset="816" stroke-linecap="round" class="circle-progress" />
            <defs>
                <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                    <stop offset="0%" stop-color="#3b82f6" />
                    <stop offset="100%" stop-color="#a855f7" />
                </linearGradient>
            </defs>
        </svg>

        <!-- Inner Content -->
        <div class="absolute top-0 left-0 w-full h-full flex flex-col justify-center items-center pointer-events-none">
            <i class="fas fa-shoe-prints text-4xl text-blue-400 mb-2 opacity-50"></i>
            <span id="step-count" class="text-6xl font-bold tracking-tighter font-mono">0</span>
            <span class="text-gray-400 mt-1 text-sm">Ù‚Ø¯Ù… Ø§Ù…Ø±ÙˆØ²</span>
            <span id="km-display" class="text-blue-300 mt-2 text-xs font-mono">0.00 Ú©ÛŒÙ„ÙˆÙ…ØªØ±</span>
        </div>

        <!-- Pulse Effect Behind -->
        <div id="active-pulse" class="absolute top-0 left-0 w-full h-full rounded-full opacity-0 transition-opacity duration-500 -z-10" style="box-shadow: 0 0 50px rgba(59, 130, 246, 0.3);"></div>
    </div>

    <!-- Controls -->
    <div class="flex gap-4 mb-8 w-full justify-center px-4">
        <button id="btn-toggle" onclick="toggleCounter()" class="flex-1 bg-gradient-to-r from-green-500 to-emerald-600 py-4 rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
            <i class="fas fa-play"></i> <span>Ø´Ø±ÙˆØ¹</span>
        </button>
        <button onclick="saveSession()" class="flex-1 glass hover:bg-white/10 py-4 rounded-2xl font-bold text-lg shadow-lg active:scale-95 transition flex items-center justify-center gap-2 text-blue-300 border-blue-500/30">
            <i class="fas fa-save"></i> <span>Ø°Ø®ÛŒØ±Ù‡ Ø±Ú©ÙˆØ±Ø¯</span>
        </button>
    </div>

    <!-- Progress to Next Coin -->
    <div class="w-11/12 glass p-4 rounded-xl mb-6 border-r-4 border-yellow-500">
        <div class="flex justify-between text-sm mb-2">
            <span class="text-gray-300">ØªØ§ Ø³Ú©Ù‡ Ø¨Ø¹Ø¯ÛŒ</span>
            <span id="steps-to-coin" class="text-yellow-400 font-mono">300 Ù‚Ø¯Ù…</span>
        </div>
        <div class="w-full bg-gray-700 h-2 rounded-full overflow-hidden">
            <div id="coin-progress-bar" class="bg-yellow-400 h-full w-0 transition-all duration-300"></div>
        </div>
        <p class="text-xs text-gray-500 mt-2">Ù‡Ø± 300 Ù‚Ø¯Ù… = 1 Ø³Ú©Ù‡ Ø¬Ø§ÛŒØ²Ù‡ ğŸª™</p>
    </div>

    <!-- Records Section -->
    <div class="w-11/12 glass rounded-2xl p-5 mb-10">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-bold text-white"><i class="fas fa-trophy text-yellow-500 ml-2"></i>ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§</h2>
            <button onclick="clearRecords()" class="text-xs text-red-400 border border-red-900 px-2 py-1 rounded hover:bg-red-900/50">Ø­Ø°Ù Ù‡Ù…Ù‡</button>
        </div>
        
        <div class="overflow-hidden rounded-lg">
            <table class="w-full text-sm text-right">
                <thead class="bg-slate-800 text-gray-400">
                    <tr>
                        <th class="p-3">ØªØ§Ø±ÛŒØ®</th>
                        <th class="p-3">Ù‚Ø¯Ù…â€ŒÙ‡Ø§</th>
                        <th class="p-3">Ø³Ú©Ù‡</th>
                    </tr>
                </thead>
                <tbody id="records-table-body" class="divide-y divide-slate-700">
                    <!-- Records will be injected here -->
                    <tr>
                        <td colspan="3" class="p-4 text-center text-gray-500">Ù‡Ù†ÙˆØ² Ø±Ú©ÙˆØ±Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-[60] hidden flex items-center justify-center p-4">
        <div class="bg-slate-800 w-full max-w-sm rounded-2xl p-6 border border-slate-600 shadow-2xl">
            <h3 class="text-xl font-bold mb-4 text-white border-b border-slate-700 pb-2">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h3>
            
            <div class="mb-6">
                <label class="block text-sm text-gray-400 mb-2">Ø­Ø³Ø§Ø³ÛŒØª Ø³Ù†Ø³ÙˆØ± (Ú©Ù…ØªØ± = Ø­Ø³Ø§Ø³â€ŒØªØ±)</label>
                <input type="range" id="sensitivity-range" min="8" max="25" value="12" class="w-full h-2 bg-slate-600 rounded-lg appearance-none cursor-pointer accent-blue-500">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>Ø²ÛŒØ§Ø¯ (Ø¯ÙˆÛŒØ¯Ù†)</span>
                    <span id="sens-val">12</span>
                    <span>Ú©Ù… (Ø±Ø§Ù‡ Ø±ÙØªÙ†)</span>
                </div>
            </div>

            <div class="mb-6">
                 <label class="block text-sm text-gray-400 mb-2">Ø·ÙˆÙ„ Ú¯Ø§Ù… (Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ú©ÛŒÙ„ÙˆÙ…ØªØ±)</label>
                 <select id="step-length" class="w-full bg-slate-700 text-white rounded p-2 outline-none">
                     <option value="0.7">Ù…Ø±Ø¯ (Ù…ØªÙˆØ³Ø· 70cm)</option>
                     <option value="0.6">Ø²Ù† (Ù…ØªÙˆØ³Ø· 60cm)</option>
                     <option value="0.5">Ú©ÙˆØ¯Ú© (Ù…ØªÙˆØ³Ø· 50cm)</option>
                 </select>
            </div>

            <div class="flex gap-2">
                <button onclick="closeSettings()" class="flex-1 bg-blue-600 py-2 rounded-lg font-bold">ØªØ§ÛŒÛŒØ¯</button>
                <button onclick="resetCurrentSteps()" class="flex-1 bg-red-600/20 text-red-400 py-2 rounded-lg border border-red-600/50">Ø±ÛŒØ³Øª Ù‚Ø¯Ù…â€ŒÙ‡Ø§</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-20 bg-yellow-500 text-black px-6 py-3 rounded-full shadow-2xl font-bold transform -translate-y-20 opacity-0 transition-all duration-500 z-50 flex items-center gap-2">
        <i class="fas fa-coins"></i>
        <span>ØªØ¨Ø±ÛŒÚ©! +1 Ø³Ú©Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ø´Ø¯</span>
    </div>

    <script>
        // --- Variables ---
        let steps = 0;
        let totalCoins = 0;
        let isRunning = false;
        let records = [];
        let sensitivity = 12; // Threshold for shake detection
        let lastAcc = { x: 0, y: 0, z: 0 };
        let lastStepTime = 0;
        let stepLength = 0.7; // meters
        
        // DOM Elements
        const stepDisplay = document.getElementById('step-count');
        const coinDisplay = document.getElementById('coin-display');
        const kmDisplay = document.getElementById('km-display');
        const btnToggle = document.getElementById('btn-toggle');
        const progressRing = document.getElementById('progress-ring');
        const activePulse = document.getElementById('active-pulse');
        const permissionBtn = document.getElementById('permission-btn');
        const coinProgressBar = document.getElementById('coin-progress-bar');
        const stepsToCoinDisplay = document.getElementById('steps-to-coin');
        const settingsModal = document.getElementById('settings-modal');
        const recordsBody = document.getElementById('records-table-body');

        // Circumference for SVG ring
        const circumference = 2 * Math.PI * 130;

        // --- Initialization ---
        window.onload = () => {
            loadData();
            renderRecords();
            checkPermissionRequirement();
            updateUI();
        };

        // --- Core Logic: Pedometer ---
        function handleMotion(event) {
            if (!isRunning) return;

            const acc = event.accelerationIncludingGravity;
            if (!acc) return; // Some devices return null

            // Calculate magnitude vector
            // We compare current magnitude vs threshold to detect a "peak" (step)
            // Simple algorithm suitable for web (not as perfect as native OS API)
            const deltaX = Math.abs(acc.x - lastAcc.x);
            const deltaY = Math.abs(acc.y - lastAcc.y);
            const deltaZ = Math.abs(acc.z - lastAcc.z);

            // Combine deltas (simple magnitude approx)
            const totalDelta = deltaX + deltaY + deltaZ;

            if (totalDelta > sensitivity) {
                const now = Date.now();
                // Debounce: prevent double counting within 350ms
                if (now - lastStepTime > 350) {
                    addStep();
                    lastStepTime = now;
                }
            }

            lastAcc = { x: acc.x, y: acc.y, z: acc.z };
        }

        function addStep() {
            steps++;
            
            // Visual Bounce
            stepDisplay.classList.remove('step-bounce');
            void stepDisplay.offsetWidth; // trigger reflow
            stepDisplay.classList.add('step-bounce');

            // Check for Coin Reward (Every 300 steps)
            if (steps % 300 === 0) {
                addCoin();
            }

            updateUI();
            saveData();
        }

        function addCoin() {
            totalCoins++;
            
            // Animate Coin Icon
            const icon = document.getElementById('coin-icon');
            icon.classList.remove('coin-anim');
            void icon.offsetWidth;
            icon.classList.add('coin-anim');

            // Show Toast
            showToast();
            saveData();
        }

        // --- UI Functions ---
        function updateUI() {
            stepDisplay.innerText = steps.toLocaleString('fa-IR');
            coinDisplay.innerText = totalCoins.toLocaleString('fa-IR');
            
            // Distance
            const km = (steps * stepLength) / 1000;
            kmDisplay.innerText = km.toFixed(2).toLocaleString('fa-IR') + ' Ú©ÛŒÙ„ÙˆÙ…ØªØ±';

            // Progress Ring (Based on daily goal of 10,000 for visual)
            const goal = 10000;
            const offset = circumference - (Math.min(steps, goal) / goal) * circumference;
            progressRing.style.strokeDashoffset = offset;

            // Coin Progress
            const progressToCoin = steps % 300;
            const percentToCoin = (progressToCoin / 300) * 100;
            coinProgressBar.style.width = `${percentToCoin}%`;
            stepsToCoinDisplay.innerText = (300 - progressToCoin).toLocaleString('fa-IR') + ' Ù‚Ø¯Ù…';
        }

        function showToast() {
            const toast = document.getElementById('toast');
            toast.classList.remove('opacity-0', '-translate-y-20');
            setTimeout(() => {
                toast.classList.add('opacity-0', '-translate-y-20');
            }, 3000);
        }

        function toggleCounter() {
            if (!isRunning) {
                requestMotionPermission().then(granted => {
                    if (granted) {
                        isRunning = true;
                        window.addEventListener('devicemotion', handleMotion, true);
                        
                        // UI updates
                        btnToggle.innerHTML = '<i class="fas fa-pause"></i> <span>ØªÙˆÙ‚Ù</span>';
                        btnToggle.classList.remove('from-green-500', 'to-emerald-600');
                        btnToggle.classList.add('from-red-500', 'to-orange-600');
                        activePulse.style.animation = 'pulse-neon 2s infinite';
                        activePulse.style.opacity = '1';
                        
                        // Keep screen awake if possible
                        if ('wakeLock' in navigator) {
                            navigator.wakeLock.request('screen').catch(console.error);
                        }
                    }
                });
            } else {
                isRunning = false;
                window.removeEventListener('devicemotion', handleMotion, true);
                
                // UI updates
                btnToggle.innerHTML = '<i class="fas fa-play"></i> <span>Ø´Ø±ÙˆØ¹</span>';
                btnToggle.classList.add('from-green-500', 'to-emerald-600');
                btnToggle.classList.remove('from-red-500', 'to-orange-600');
                activePulse.style.animation = 'none';
                activePulse.style.opacity = '0';
            }
        }

        // --- Permissions (Crucial for iOS 13+) ---
        function checkPermissionRequirement() {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                permissionBtn.classList.remove('hidden');
                permissionBtn.onclick = () => {
                    DeviceMotionEvent.requestPermission()
                        .then(response => {
                            if (response == 'granted') {
                                permissionBtn.classList.add('hidden');
                                toggleCounter(); // Start immediately
                            } else {
                                alert('Ø§Ø¬Ø§Ø²Ù‡ Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø¯ Ø´Ø¯. Ø¨Ø¯ÙˆÙ† Ø³Ù†Ø³ÙˆØ± Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù† Ù‚Ø¯Ù… Ø´Ù…Ø±Ø¯.');
                            }
                        })
                        .catch(console.error);
                };
            }
        }

        async function requestMotionPermission() {
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                // iOS 13+ path (must be triggered by user interaction)
                try {
                    const response = await DeviceMotionEvent.requestPermission();
                    return response === 'granted';
                } catch (e) {
                    console.error(e);
                    return false;
                }
            }
            return true; // Android/Old iOS usually works without explicit request if https
        }

        // --- Data Persistence ---
        function saveSession() {
            if (steps === 0) return;

            const record = {
                id: Date.now(),
                date: new Date().toLocaleDateString('fa-IR', { hour: '2-digit', minute: '2-digit' }),
                count: steps,
                earnedCoins: Math.floor(steps / 300)
            };

            records.unshift(record); // Add to top
            // Keep only top 20 records
            if (records.length > 20) records.pop();

            localStorage.setItem('stepRecords', JSON.stringify(records));
            
            // Add coins from this session globally (if logic requires separate bank)
            // NOTE: In this logic, coins are already added to global totalCoins.
            // This button just saves the entry to the table.
            
            renderRecords();
            
            // Reset current session steps but keep coins? 
            // Or just save checkpoint. Let's just save checkpoint.
            alert('Ø±Ú©ÙˆØ±Ø¯ ÙØ¹Ù„ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø± Ø¬Ø¯ÙˆÙ„ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!');
        }

        function loadData() {
            const savedSteps = localStorage.getItem('currentSteps');
            const savedCoins = localStorage.getItem('totalCoins');
            const savedRecords = localStorage.getItem('stepRecords');

            if (savedSteps) steps = parseInt(savedSteps);
            if (savedCoins) totalCoins = parseInt(savedCoins);
            if (savedRecords) records = JSON.parse(savedRecords);
        }

        function saveData() {
            localStorage.setItem('currentSteps', steps);
            localStorage.setItem('totalCoins', totalCoins);
        }

        function renderRecords() {
            recordsBody.innerHTML = '';
            if (records.length === 0) {
                recordsBody.innerHTML = '<tr><td colspan="3" class="p-4 text-center text-gray-500">Ù‡Ù†ÙˆØ² Ø±Ú©ÙˆØ±Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>';
                return;
            }

            records.forEach(rec => {
                const row = `
                    <tr class="hover:bg-white/5 transition">
                        <td class="p-3 text-gray-300">${rec.date}</td>
                        <td class="p-3 font-bold text-blue-300">${rec.count.toLocaleString('fa-IR')}</td>
                        <td class="p-3 text-yellow-400">+${rec.earnedCoins}</td>
                    </tr>
                `;
                recordsBody.innerHTML += row;
            });
        }

        function clearRecords() {
            if(confirm('Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªÙ…Ø§Ù… Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ Ø±Ø§ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯ØŸ')) {
                records = [];
                localStorage.removeItem('stepRecords');
                renderRecords();
            }
        }

        // --- Settings Functions ---
        function openSettings() {
            settingsModal.classList.remove('hidden');
        }
        function closeSettings() {
            settingsModal.classList.add('hidden');
            sensitivity = parseInt(document.getElementById('sensitivity-range').value);
            stepLength = parseFloat(document.getElementById('step-length').value);
            document.getElementById('sens-val').innerText = sensitivity;
        }
        function resetCurrentSteps() {
            if(confirm('Ø¢ÛŒØ§ Ù‚Ø¯Ù…â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² ØµÙØ± Ø´ÙˆØ¯ØŸ (Ø³Ú©Ù‡ Ù‡Ø§ Ø¨Ø§Ù‚ÛŒ Ù…ÛŒâ€ŒÙ…Ø§Ù†Ù†Ø¯)')) {
                steps = 0;
                updateUI();
                saveData();
                closeSettings();
            }
        }

        // Settings listeners
        document.getElementById('sensitivity-range').addEventListener('input', (e) => {
            document.getElementById('sens-val').innerText = e.target.value;
        });

    </script>
</body>
</html>

